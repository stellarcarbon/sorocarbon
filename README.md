# SOROCARBON

Home of Stellarcarbon's Soroban smart contracts

## Project Structure

This repository uses the recommended structure for a Soroban project:

```text
.
â”œâ”€â”€ contracts
â”‚Â Â  â””â”€â”€ sink_carbon
â”‚Â Â      â”œâ”€â”€ src
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ tests/
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ contract.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ errors.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ lib.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ storage_types.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ utils.rs
â”‚Â Â      â”œâ”€â”€ Cargo.toml
â”‚Â Â      â””â”€â”€ README.md
â”œâ”€â”€ Cargo.toml
â””â”€â”€ README.md
```

## Soroban Setup

If you haven't worked on Soroban contracts before, you'll need to set up a local development environment.
Start with the excellent [Soroban documentation](https://developers.stellar.org/docs/build/smart-contracts/overview).
We've reused some snippets here, under the Apache-2.0 license.

## Testing

Run `cargo test` to run the test suite.

```sh
cargo test
```

Or, to display backtraces when there are failures:

```sh
RUST_BACKTRACE=1 cargo test
```

You should see output similar to:

```text
running 16 tests
test tests::test_sink_carbon::test_quantize_to_kg ... ok
test tests::test_sink_carbon::test_funder_balance_too_low ... ok
test tests::test_sink_carbon::test_sink_carbon_separate_recipient ... ok
test tests::test_sink_carbon::test_funder_account_or_trustline_missing ... ok
...
```

### Mutation testing

We use [mutation testing](https://developers.stellar.org/docs/build/guides/testing/mutation-testing)
to identify code that is poorly tested.
Run `cargo mutants` to execute the test suite with mutants of the contract code.
Contract code that can be mutated without having an effect on the test outcomes tends to indicate
that this line isn't yet being tested properly.

First install cargo-mutants globally:

```sh
cargo install cargo-mutants
```

Then, you should be able to:

```sh
cargo mutants --profile=mutants
```

If such lack of test coverage is found, you should see output similar to:

```text
Found 33 mutants to test
ok       Unmutated baseline in 15.7s build + 0.4s test
 INFO Auto-set test timeout to 20s
MISSED   contracts/sink_carbon/src/storage_types.rs:4:51: replace * with + in 0.8s build + 0.4s test
MISSED   contracts/sink_carbon/src/storage_types.rs:18:5: replace extend_instance_ttl with () in 0.8s build + 0.4s test
MISSED   contracts/sink_carbon/src/storage_types.rs:5:71: replace - with / in 0.8s build + 0.4s test
33 mutants tested in 52s: 3 missed, 28 caught, 2 unviable
```

Cargo-mutants can be slow to complete with a vanilla cargo build setup.
See the guide on [improving performance](https://mutants.rs/performance.html) to speed up these runs.

## Build the Contract

To build a smart contract to deploy or run, use the `stellar contract build` command.

```sh
stellar contract build
```

If you get an error like `can't find crate for 'core'`, it means you didn't install the wasm32 target
during the [Soroban setup](https://developers.stellar.org/docs/build/smart-contracts/getting-started/setup).
You can fix it by running `rustup target add wasm32v1-none`.

### Optimization

Use `stellar contract optimize` to further minimize the size of the `.wasm`.
First, re-install stellar-cli with the `opt` feature:

```sh
cargo install --locked stellar-cli --features opt
```

Then build an optimized `.wasm` file:

```sh
stellar contract optimize --wasm target/wasm32v1-none/release/sink_carbon.wasm
```

This will optimize and output a new `sink_carbon.optimized.wasm` file in the same location as the input `.wasm`.

## Release and Deploy

The release process is incorporated into CI/CD using the [soroban-build-workflow](https://github.com/stellar-expert/soroban-build-workflow/).
To deploy the latest release to testnet, first download it [from GitHub](https://github.com/stellarcarbon/sorocarbon/releases).
Deploying a locally built WASM can break the attestations that are generated by the workflow.

### Upload

Upload the contract WASM bytes to the network with stellar-cli:

```sh
stellar contract upload \
  --network testnet \
  --source <SOURCE_ACCOUNT> \
  --wasm ~/Downloads/sink-carbon_v0.3.0.wasm
```

The (stdout) output is the WASM hash:

```text
â„¹ï¸  Simulating install transactionâ€¦
â„¹ï¸  Signing transaction: d8de6f2a24633ab73d0d37bcc0c4a4c75d5dbbd281d837ec82daad49771b6cec
ğŸŒ Submitting install transactionâ€¦
e3228c821ab8ca8c63bce736fe767f1b3c3297578e626b1decfd19225b0b1198
```

### Deploy

The contract configuration is very important. The CarbonSINK issuer must be set as the contract admin,
because it's going to delegate its own admin privileges to the `SinkContract`. There is a recovery
mechanism that can set the CarbonSINK SAC admin, which expects the contract admin to be the CarbonSINK
issuer.

```sh
PREV_SINK=$(stellar contract alias show sink --network testnet)  # only applies for upgrades
CARBON_ISSUER="GDT5XM5C5STQZS5R3F4CEGKJWKDVWBIWBEV4TIYV5MDVVMKA775T4OKY"
CSINK_ISSUER="GBO66IRGFZE7UP7MAM5H5IBMZLTM64XE6YNOL4KSL2BFVH7JW6AEKZHO"
CARBON_SAC="$(stellar contract id asset --network testnet --asset CARBON:$CARBON_ISSUER)"
CSINK_SAC="$(stellar contract id asset --network testnet --asset CarbonSINK:$CSINK_ISSUER)"

stellar contract deploy \
  --wasm-hash <HASH> \
  --network testnet \
  --source <SOURCE_ACCOUNT> \
  --alias sink \
  -- \
  --admin $CSINK_ISSUER \
  --carbon_id $CARBON_SAC \
  --carbonsink_id $CSINK_SAC
```

The (stdout) output is the contract address of the instance you've just deployed:

```text
â„¹ï¸  Using wasm hash e3228c821ab8ca8c63bce736fe767f1b3c3297578e626b1decfd19225b0b1198
â„¹ï¸  Simulating deploy transactionâ€¦
â„¹ï¸  Transaction hash is 47cc19ad6219610cc32f9285641e332079d4dc41b994b4878c0ce3c97a734199
ğŸ”— https://stellar.expert/explorer/testnet/tx/47cc19ad6219610cc32f9285641e332079d4dc41b994b4878c0ce3c97a734199
â„¹ï¸  Signing transaction: 47cc19ad6219610cc32f9285641e332079d4dc41b994b4878c0ce3c97a734199
ğŸŒ Submitting deploy transactionâ€¦
ğŸ”— https://stellar.expert/explorer/testnet/contract/CAQWMP2EKO4SQ7VQTIYCNUXASDY7WI5EKEGJXMS7W6AICI6YXPNAB4J5
âœ… Deployed!
âš ï¸  Overwriting existing contract id: CAQWMP2EKO4SQ7VQTIYCNUXASDY7WI5EKEGJXMS7W6AICI6YXPNAB4J5
CBW45IZ3W5BBDIKTIXQEAOR3TAHPCFIAVQMD4NO2YPX2FA4LKGLJLWYL
```

Within stellar-cli, the contract is now also available under the `sink` alias.

Finally, we need to make the contract address the CarbonSINK SAC admin. Configuring the contracts this way,
achieves that the CarbonSINK SAC can automatically authorize the SAC sub-calls within `sink_carbon`.

```sh
# Reset CarbonSINK SAC admin to its own issuer account
if [ -n "$PREV_SINK" ]; then
  stellar contract invoke \
    --network testnet \
    --source <CSINK_ISSUER_SECRET> \
    --id $PREV_SINK \
    -- \
    reset_admin
fi

# Set the new SinkContract as the CarbonSINK SAC admin
stellar contract invoke \
  --network testnet \
  --source <CSINK_ISSUER_SECRET> \
  --id $CSINK_SAC \
  -- \
  set_admin \
  --new_admin $(stellar contract alias show sink --network testnet)
```

When successful, the output shows a `set_admin` event:

```text
â„¹ï¸  Contract alias 'sink' references CBW45IZ3W5BBDIKTIXQEAOR3TAHPCFIAVQMD4NO2YPX2FA4LKGLJLWYL
  on network 'Test SDF Network ; September 2015'
â„¹ï¸  Signing transaction: 8e110505d76c9f8456e98f255bb7cc4b09be8c1f5e9003d0b6deecd7e11d9e9c
ğŸ“… CCUQDX22YTF72Q2F5C4HZSWVMBFTPTLIYXOC3BSNTBSZVJWKMMNUOWXH - Event:
  [
    {"symbol":"set_admin"},
    {"address":"GBO66IRGFZE7UP7MAM5H5IBMZLTM64XE6YNOL4KSL2BFVH7JW6AEKZHO"},
    {"string":"CarbonSINK:GBO66IRGFZE7UP7MAM5H5IBMZLTM64XE6YNOL4KSL2BFVH7JW6AEKZHO"}
  ] =
    {"address":"CBW45IZ3W5BBDIKTIXQEAOR3TAHPCFIAVQMD4NO2YPX2FA4LKGLJLWYL"}
```

### Mercury Retroshades

We use Retroshades to emit events instead of native Soroban events.
Deploy a slimmed-down version of the sink carbon contract to Mercury with:

```sh
./deploy-retroshades.sh
```

You'll need to have your own Mercury account and API key to do this.
The retroshade will listen to the invocations of the "sink" alias from the stellar-cli by default.
